目标：
1. 理解什么是tick 




内容：

参考文档： https://github.com/raydium-io/raydium-docs/blob/master/dev-resources/raydium-clmm-dev-doc.pdf

Protocol Concepts 
1. Tick 
在CLMM中，整个price range 是均匀分配的离散ticks进行分割。 每个tick 有一个 index 并且对应一个价格：
p(i) = 1.0001^i
这里p(i) 是tick为i时的价格。 采用1.0001的幂有一个很好的属性：两个 adjacent ticks之间的差距是 0.01% 或者说 1 basis point. 
CLMM 存储sqrt(p), not p. 因此，该公式事实上是: sqrt(p_i) = sqrt(1.0001^i) = 1.0001^(i/2).

Ticks 是整数，可以是正数或者负数。 但是，它们不是无限大的。 CLMM 存储sqrt(p) 作为一个fixed point Q64.64 number, 这是 rational number 使用64 bits 用于表示整数， 64 bits来表示小数部分。 因此Prices(equal to the squre of sqrt(P) 在 [2^-64, 2^64]. 而ticks在[-443636,443636]. 

2. Tick Spacing 
selectable ticks的范围是非常大的，同时adjacent ticks的价格差异是非常小的。 该特性对于一些cryptocurrencies的价格是很有必要的，比如说stablecoin pools. 但是对于池子with high prices and large price fluctuations, 比如说Bitcoin, 这是不必要的。所以tickspacing的概念was introduced in CLMM, 这代表ticks的间隔 以及在两个tickspacing键的ticks 可以被ignored 并且不参与计算 【TODO: ？】

这又几个好处：
2.1. 节省 compute cost 以及 rent constraints 
2.2. 用户可定义价格范围的粒度(granularity)

你的tick-spacing越小，用户存入的流动性价格粒度更细致。 对于大多数稳定池，一个更粒度tick-spacing 将让用户定义一个更为tighter range 来maximize 它们的leverage. 

举例： [TODO: ]





3. Maximum price movement per swap 
tick-spacing的大小定义了一个swap，对于个池子可以移动的价格的最大价格范围

swap 通过iterating through 每个ticks with initialized liquidity 来执行。 在initialized ticks的间隔更大， 理论上它traverse的价格范围更大。 一个low tick-spacing pool 想要经历 a massive price movement, 可能需要 multiple swap instructions to complete the price movement. 因此， 更多 volatile pairs 经常有 large price swings，需要寻求higher tick-spacing 来 pool users mitigate this pain point [TODO: why it's a pain point for pool users]. 


3. Tick Array 
A tick array is a collection of ticks. A tick-array 被keyed by the start-index [TODO:] of its hosted ticks[TODO: ？]and can hold 60 physical tick [TODO: ?] in an array. It 仅 hosts the tick objects for the initializable tick indices [TODO:] 基于 pool's tick-spacing. 对于一个tick-array的 total range是 60*tick-spacing. 

问题1：  start-index含义及其计算公式
    /// Input an arbitrary tick_index, output the start_index of the tick_array it sits on
    pub fn get_array_start_index(tick_index: i32, tick_spacing: u16) -> i32 {
       
        // tick_index:-71340
        // tick_spacing:60
        println!("tick_index:{}", tick_index);
        println!("tick_spacing:{}", tick_spacing);

        let ticks_in_array = TickArrayState::tick_count(tick_spacing);
        //ticks_in_array:3600
        println!("ticks_in_array:{}", ticks_in_array);
        let mut start = tick_index / ticks_in_array;
        // start:-19
        println!("start:{}", start);
        if tick_index < 0 && tick_index % ticks_in_array != 0 {
            start = start - 1
        }
        // start:-20
        println!("start:{}", start);
        start * ticks_in_array
    }




3.1 在指令中的应用
当你 和clmm上的指令的tick进行交互时， 经常你可能需要 derive the correct tick-array, 因此program可以get access to the designated tick object. 

3.1.1 Open Position
A position opening up in a bran new tick/price area would need to initialize the tick-array prior to creating the position. 
这意味着，invode 该position的用户将必须支付 rent-exempt cost. 

3.1.2 Mofiy Liquidity(increase/decrease liquidity) [TODO:]
这些指令的user 需要 pass in the tick-array,这些tick-array houses the tick-index that are passed in. 该指令需要获取这些账户[TODO:]来读取适合的tick object. 

3.1.3 Swap
Swap users需要提供 series of tick-arrays[TODO:] ，swap将会 traverse across 这写tick arrays. 
在sequence中的第一个tick-array is that houses the pool's current tick index. The remaining tick arrays 是 next tick-arrays in the swap direction . 


---------------------------------------------------------------------------------------------------------------------


1. tick 
定义：
在CLMM中，整个价格范围由均匀分布【1】的离散价格【2】标记（ticks）来界定。每个标记【7】都有一个索引【3】，并对应【4】一个特定的价格：
`p(i) = 1.0001^i`

其中 `p(i)` 是标记 `i` 的价格。
取 `1.0001` 的幂具有一个理想的属性：相邻两个标记之间的差异为0.01%或1个基点(basis point)。【5】

CLMM 存储的是 `√P`【6】，而不是 `P`。因此，公式实际上是：

`√p_i = √(1.0001^i) = 1.0001^(i/2)`

标记可以是正数或负数的整数【8】，当然，它们不是无限的。 CLMM 存储 `√P` 为一个固定点 Q64.64 数字，这个数字使用64位表示整数部分，64位表示小数部分。因此，价格（等于 `√P` 的平方）处于以下范围【9】内：  
`[2^(-64), 2^64]`  
而标记的范围【10】则是：  
`[-443636, 443636]`

举例：
As an example, √
𝑝(0)—the square root price at tick 0—is 1,
√
𝑝(1)
is √
1.0001 ≈ 1.00005, and √
𝑝(−1) is 1 √
1.0001
≈ 0.99995.


There is a tick at every price p that is an integer power of 1.0001. 




1.1 引入tick  标记的目的是？ 
最核心的原因在于离散化价格，也就是将连续的价格区间分割成固定的、均匀的间隔（ticks）。通过这一过程，价格变动不再是无穷小的，而是具有可控制的、有限的范围。这个离散化的过程可以极大地简化计算，减少误差，并且在实际交易中为参与者提供更可预测和更稳定的价格波动。

1.2 ticks 特性 
参考来源：https://docs.uniswap.org/concepts/protocol/concentrated-liquidity
特性1： 基于tick计算价格方式
Ticks are the boundaries between discrete areas in price space. Ticks are spaced such that an increase or decrease of 1 tick represents a 0.01% increase or decrease in price at any point in price space.

举例：
Let’s assume that a particular asset’s price space is represented by ticks, where the price can change in discrete steps. In this example:

Each tick represents a 0.01% change in price.

Step-by-step explanation:
Starting Price:
Suppose the current price of the asset is 100.

Price Increase by 1 Tick:
If the price increases by 1 tick, that represents a 0.01% increase.
A 0.01% increase in price from 100 is calculated as:

100
×
0.0001
=
0.01
100×0.0001=0.01
So, the new price after a 1 tick increase will be:

100
+
0.01
=
100.01
100+0.01=100.01
Price Decrease by 1 Tick:
Similarly, if the price decreases by 1 tick, that represents a 0.01% decrease.
A 0.01% decrease from 100 is:

100
×
0.0001
=
0.01
100×0.0001=0.01
So, the new price after a 1 tick decrease will be:

100
−
0.01
=
99.99
100−0.01=99.99
In conclusion:
Each tick moves the price by a fixed 0.01% either up or down.

From a starting price of 100, moving 1 tick up will result in a price of 100.01, while moving 1 tick down will result in a price of 99.99.


1.3 tick 做为boundary的解释
Imagine you're at a fence that separates two properties, and the fence acts as the boundary between them. You can't cross from one property to the other without going through the fence. In the same way, in the context of price space, each tick serves as a boundary that defines the minimum price movement. If you want the price to go from one level to the next, you must cross a boundary (i.e., move one tick).

Visualizing the Concept:
Consider this example with a starting price of 100:

Boundary 1: Price 100.00 (the first boundary or level).

Boundary 2: Price 100.01 (after the first tick increase, crossing to the next boundary).

Boundary 3: Price 100.02 (after the second tick increase, crossing again).

So, the boundaries are the points where the price moves to the next level, and each time the price crosses a boundary, it increments by a fixed amount (like 0.01%).

In this case:

Boundaries are the discrete price levels such as 100.00, 100.01, 100.02, etc.

The price can only move between these boundaries by crossing them in steps defined by the tick size (0.01% in your example).

1.4 tick 和流动性仓位关系
Ticks function as boundaries for liquidity positions. When a position is created, the provider must choose the lower and upper tick that will represent their position's borders.

1.5 tick 在swap中的作用
As the spot price changes during swapping, the pool contract will continuously exchange the outbound asset for the inbound, progressively using all the liquidity available within the current tick interval1 until the next tick is reached. At this point, the contract switches to a new tick and activates any dormant liquidity within a position that has a boundary at the newly active tick.

解释：
1. Spot Price and Ticks:
The spot price changes continuously as assets are swapped. In a CLMM, the liquidity is concentrated within specific tick intervals, and as the price moves, the pool contract will progressively use all the liquidity within the current tick interval until it hits the next tick boundary.

2. Contract Switching Ticks:
Once the spot price reaches the next tick boundary, the contract switches to the next interval and activates any liquidity that has been dormant in that tick interval. This is what allows liquidity providers to focus their capital on smaller price ranges, optimizing their capital efficiency.
举例：
1. Example:
Let’s assume we are dealing with a pool that has two assets: Asset A and Asset B. The price of Asset A is 100 when we begin the swap. For simplicity, let’s say we are swapping Asset B for Asset A.

Initial State:

The pool has liquidity concentrated between the price range of 100 and 101. This means that the ticks in this range are active, and the liquidity can be used for swaps.

Let’s say the tick interval is 0.01, meaning that the price can move in increments of 0.01.

Swap Starts:

The spot price starts at 100 and is used for the swap.

As Asset A is swapped into the pool for Asset B, the pool contract will use the liquidity available in the range from 100.00 to 100.01.

Spot Price Reaches Next Tick (100.01):

As the swap continues, the spot price increases to 100.01. At this point, the contract has used up all the liquidity in the 100.00-100.01 range.

Now, the contract will switch to the next tick boundary, which is 100.01, and activate any liquidity that was dormant at this price range.

The liquidity between 100.01 and 100.02 becomes active and can now be used for further swaps.

Liquidity Usage Continues:

The spot price continues to increase as swaps happen, and as it crosses each tick boundary (e.g., 100.02, 100.03), the contract will keep switching to the new ticks, activating dormant liquidity within that range.

The process will continue until the price reaches a point where liquidity is exhausted or until the price changes enough to hit a new price range, triggering the activation of new liquidity.


1.6 每个池子的ticks数量是固定的 ，但是只有一部分serve as active ticks. 
active ticks解释：
The active ticks are the ones where liquidity providers have deposited liquidity for price ranges that are currently being used.
When the price reaches the tick boundaries, the liquidity in that tick becomes active and can be used for swaps.

1.7 tick spacing 和 swap fee的关系
swap fee解释：
A swap fee is the fee charged to traders when swapping assets in the pool.

Lower Fee Tiers (e.g., 0.05%):
For lower fee tiers, liquidity providers are incentivized to have liquidity in smaller price ranges. This means the ticks in these pools can be closer together, meaning price changes can happen in smaller increments.

Why Does This Happen?  【small price movements】
Lower Fee Tiers (Closer Ticks):
In lower fee tiers (like 0.05%), there’s a greater incentive for liquidity providers to position their liquidity closer together. Since the fee is low, the trading volume would need to be higher to make a good return on investment. Therefore, more granular price steps (closer ticks) allow liquidity providers to better capture small price movements and take advantage of more trading opportunities.



Higher Fee Tiers (e.g., 1%):
For higher fee tiers, liquidity providers are incentivized to have liquidity over wider price ranges. This means the ticks are farther apart, and the price increments are larger, which allows for higher potential fees for liquidity providers due to higher trading volume or larger price movements.

Higher Fee Tiers (Wider Ticks):
In higher fee tiers (like 1%), liquidity providers can afford to have liquidity spread over a wider price range, as they earn more fees per trade. The fewer trades (due to higher fees), the wider the tick spacing can be, allowing for more flexibility in where liquidity is placed.


示例：
Let’s assume we have a Uniswap V3 pool with Asset A and Asset B. The current price is 100 Asset B per 1 Asset A.

Pool with 0.05% Fee Tier:

In a low-fee pool, ticks might be spaced closely together. For example:

Tick 1: Price = 100 (Asset A = 100 Asset B)

Tick 2: Price = 100.01

Tick 3: Price = 100.02

Tick 4: Price = 100.03

The closer tick spacing allows liquidity providers to position liquidity in smaller, more granular price ranges.

In this case, closer ticks allow liquidity providers to capture more small price movements since they can place liquidity closer to the current price.



Pool with 1% Fee Tier:

In a high-fee pool, ticks might be spaced farther apart. For example:

Tick 1: Price = 100 (Asset A = 100 Asset B)

Tick 2: Price = 102

Tick 3: Price = 104

Tick 4: Price = 106

The wider tick spacing means liquidity providers are providing liquidity over a larger price range.

In this case, the wider tick spacing reflects the fact that liquidity providers are expecting less frequent trades due to the higher fee, but they earn higher fees per trade.



1.8. tick对交易成本的影响
While inactive ticks have no impact on transaction cost during swaps, crossing an active tick does increase the cost of the transaction in which it is crossed, as the tick crossing will activate the liquidity within any new positions using the given tick as a border.

示例：
Example to Illustrate:
Let’s assume you’re swapping Asset A for Asset B, and the price of Asset A is currently 100 (per Asset B).

Initial Ticks:

Tick 1: Price 100 (Liquidity active here).

Tick 2: Price 101 (Liquidity active here).

Tick 3: Price 102 (Liquidity inactive here).

So, the current active ticks are at 100 and 101, and liquidity is available only at these levels.

Swap Starts:
Let’s say you’re swapping Asset A for Asset B, and the spot price starts at 100.

Tick Crossing:
If the price moves from 100 to 101, tick 2 gets crossed. This means that the contract is now activating the liquidity in the 101 price range. As a result, the transaction cost increases because liquidity is now being used at the new price range (101).

Before crossing tick 2: The pool only had liquidity at tick 1 (100).

After crossing tick 2: The pool now activates liquidity at tick 2 (101), and the price needs to adjust according to the available liquidity.

This means you might end up paying a slightly higher price for Asset B than expected because the price range has shifted and liquidity has moved.


1.9 稳定币交易应该采用较低的tick spacking 
In areas where capital efficiency is paramount, such as stable coin pairs, narrower tick spacing increases the granularity of liquidity provisioning and will likely lower price impact when swapping - the result being significantly improved prices for stable coin swaps.


1.10 Tick 和 virtual liquidity的关系？ 
Ticks represent prices at
which the virtual liquidity of the contract can change

1.11 当liquidity 被添加到 a range?
如果 one or both of the ticks 没有作为 a bound in an existing position, that  tick is  initialized. 
existing position如何理解？ 
means that other liquidity providers might have already provided liquidity between those ticks.

initialize tick什么意思?
Initialized here means that the system sets up that tick as an active boundary for liquidity provision. Essentially, the tick starts functioning as a price level that will now hold liquidity.
Initialization makes the tick available for active trading. Without initializing the tick, the price level wouldn’t have liquidity available to be used in trades.

range如何理解？ 有两个tick构成，分别构成左 bound 和 右 bound 
As a liquidity provider, you're adding your liquidity to a specific price range (which is defined by two ticks, e.g., from tick 100 to tick 105).


1.12 tickspace是谁设定的？ 







拓展学习:
1. https://app.uniswap.org/whitepaper-v3.pdf