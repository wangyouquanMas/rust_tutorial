ç›®æ ‡ï¼š
1. ç†è§£ä»€ä¹ˆæ˜¯tick 




å†…å®¹ï¼š

å‚è€ƒæ–‡æ¡£ï¼š https://github.com/raydium-io/raydium-docs/blob/master/dev-resources/raydium-clmm-dev-doc.pdf

Protocol Concepts 
1. Tick 
åœ¨CLMMä¸­ï¼Œæ•´ä¸ªprice range æ˜¯å‡åŒ€åˆ†é…çš„ç¦»æ•£ticksè¿›è¡Œåˆ†å‰²ã€‚ æ¯ä¸ªtick æœ‰ä¸€ä¸ª index å¹¶ä¸”å¯¹åº”ä¸€ä¸ªä»·æ ¼ï¼š
p(i) = 1.0001^i
è¿™é‡Œp(i) æ˜¯tickä¸ºiæ—¶çš„ä»·æ ¼ã€‚ é‡‡ç”¨1.0001çš„å¹‚æœ‰ä¸€ä¸ªå¾ˆå¥½çš„å±žæ€§ï¼šä¸¤ä¸ª adjacent ticksä¹‹é—´çš„å·®è·æ˜¯ 0.01% æˆ–è€…è¯´ 1 basis point. 
CLMM å­˜å‚¨sqrt(p), not p. å› æ­¤ï¼Œè¯¥å…¬å¼äº‹å®žä¸Šæ˜¯: sqrt(p_i) = sqrt(1.0001^i) = 1.0001^(i/2).

Ticks æ˜¯æ•´æ•°ï¼Œå¯ä»¥æ˜¯æ­£æ•°æˆ–è€…è´Ÿæ•°ã€‚ ä½†æ˜¯ï¼Œå®ƒä»¬ä¸æ˜¯æ— é™å¤§çš„ã€‚ CLMM å­˜å‚¨sqrt(p) ä½œä¸ºä¸€ä¸ªfixed point Q64.64 number, è¿™æ˜¯ rational number ä½¿ç”¨64 bits ç”¨äºŽè¡¨ç¤ºæ•´æ•°ï¼Œ 64 bitsæ¥è¡¨ç¤ºå°æ•°éƒ¨åˆ†ã€‚ å› æ­¤Prices(equal to the squre of sqrt(P) åœ¨ [2^-64, 2^64]. è€Œticksåœ¨[-443636,443636]. 

2. Tick Spacing 
selectable ticksçš„èŒƒå›´æ˜¯éžå¸¸å¤§çš„ï¼ŒåŒæ—¶adjacent ticksçš„ä»·æ ¼å·®å¼‚æ˜¯éžå¸¸å°çš„ã€‚ è¯¥ç‰¹æ€§å¯¹äºŽä¸€äº›cryptocurrenciesçš„ä»·æ ¼æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œæ¯”å¦‚è¯´stablecoin pools. ä½†æ˜¯å¯¹äºŽæ± å­with high prices and large price fluctuations, æ¯”å¦‚è¯´Bitcoin, è¿™æ˜¯ä¸å¿…è¦çš„ã€‚æ‰€ä»¥tickspacingçš„æ¦‚å¿µwas introduced in CLMM, è¿™ä»£è¡¨ticksçš„é—´éš” ä»¥åŠåœ¨ä¸¤ä¸ªtickspacingé”®çš„ticks å¯ä»¥è¢«ignored å¹¶ä¸”ä¸å‚ä¸Žè®¡ç®— ã€TODO: ï¼Ÿã€‘

è¿™åˆå‡ ä¸ªå¥½å¤„ï¼š
2.1. èŠ‚çœ compute cost ä»¥åŠ rent constraints 
2.2. ç”¨æˆ·å¯å®šä¹‰ä»·æ ¼èŒƒå›´çš„ç²’åº¦(granularity)

ä½ çš„tick-spacingè¶Šå°ï¼Œç”¨æˆ·å­˜å…¥çš„æµåŠ¨æ€§ä»·æ ¼ç²’åº¦æ›´ç»†è‡´ã€‚ å¯¹äºŽå¤§å¤šæ•°ç¨³å®šæ± ï¼Œä¸€ä¸ªæ›´ç²’åº¦tick-spacing å°†è®©ç”¨æˆ·å®šä¹‰ä¸€ä¸ªæ›´ä¸ºtighter range æ¥maximize å®ƒä»¬çš„leverage. 

ä¸¾ä¾‹ï¼š [TODO: ]





3. Maximum price movement per swap 
tick-spacingçš„å¤§å°å®šä¹‰äº†ä¸€ä¸ªswapï¼Œå¯¹äºŽä¸ªæ± å­å¯ä»¥ç§»åŠ¨çš„ä»·æ ¼çš„æœ€å¤§ä»·æ ¼èŒƒå›´

swap é€šè¿‡iterating through æ¯ä¸ªticks with initialized liquidity æ¥æ‰§è¡Œã€‚ åœ¨initialized ticksçš„é—´éš”æ›´å¤§ï¼Œ ç†è®ºä¸Šå®ƒtraverseçš„ä»·æ ¼èŒƒå›´æ›´å¤§ã€‚ ä¸€ä¸ªlow tick-spacing pool æƒ³è¦ç»åŽ† a massive price movement, å¯èƒ½éœ€è¦ multiple swap instructions to complete the price movement. å› æ­¤ï¼Œ æ›´å¤š volatile pairs ç»å¸¸æœ‰ large price swingsï¼Œéœ€è¦å¯»æ±‚higher tick-spacing æ¥ pool users mitigate this pain point [TODO: why it's a pain point for pool users]. 


3. Tick Array 
A tick array is a collection of ticks. A tick-array è¢«keyed by the start-index [TODO:] of its hosted ticks[TODO: ï¼Ÿ]and can hold 60 physical tick [TODO: ?] in an array. It ä»… hosts the tick objects for the initializable tick indices [TODO:] åŸºäºŽ pool's tick-spacing. å¯¹äºŽä¸€ä¸ªtick-arrayçš„ total rangeæ˜¯ 60*tick-spacing. 

é—®é¢˜1ï¼š  start-indexå«ä¹‰åŠå…¶è®¡ç®—å…¬å¼
    /// Input an arbitrary tick_index, output the start_index of the tick_array it sits on
    pub fn get_array_start_index(tick_index: i32, tick_spacing: u16) -> i32 {
       
        // tick_index:-71340
        // tick_spacing:60
        println!("tick_index:{}", tick_index);
        println!("tick_spacing:{}", tick_spacing);

        let ticks_in_array = TickArrayState::tick_count(tick_spacing);
        //ticks_in_array:3600
        println!("ticks_in_array:{}", ticks_in_array);
        let mut start = tick_index / ticks_in_array;
        // start:-19
        println!("start:{}", start);
        if tick_index < 0 && tick_index % ticks_in_array != 0 {
            start = start - 1
        }
        // start:-20
        println!("start:{}", start);
        start * ticks_in_array
    }




3.1 åœ¨æŒ‡ä»¤ä¸­çš„åº”ç”¨
å½“ä½  å’Œclmmä¸Šçš„æŒ‡ä»¤çš„tickè¿›è¡Œäº¤äº’æ—¶ï¼Œ ç»å¸¸ä½ å¯èƒ½éœ€è¦ derive the correct tick-array, å› æ­¤programå¯ä»¥get access to the designated tick object. 

3.1.1 Open Position
A position opening up in a bran new tick/price area would need to initialize the tick-array prior to creating the position. 
è¿™æ„å‘³ç€ï¼Œinvode è¯¥positionçš„ç”¨æˆ·å°†å¿…é¡»æ”¯ä»˜ rent-exempt cost. 

3.1.2 Mofiy Liquidity(increase/decrease liquidity) [TODO:]
è¿™äº›æŒ‡ä»¤çš„user éœ€è¦ pass in the tick-array,è¿™äº›tick-array houses the tick-index that are passed in. è¯¥æŒ‡ä»¤éœ€è¦èŽ·å–è¿™äº›è´¦æˆ·[TODO:]æ¥è¯»å–é€‚åˆçš„tick object. 

3.1.3 Swap
Swap userséœ€è¦æä¾› series of tick-arrays[TODO:] ï¼Œswapå°†ä¼š traverse across è¿™å†™tick arrays. 
åœ¨sequenceä¸­çš„ç¬¬ä¸€ä¸ªtick-array is that houses the pool's current tick index. The remaining tick arrays æ˜¯ next tick-arrays in the swap direction . 


---------------------------------------------------------------------------------------------------------------------


1. tick 
å®šä¹‰ï¼š
åœ¨CLMMä¸­ï¼Œæ•´ä¸ªä»·æ ¼èŒƒå›´ç”±å‡åŒ€åˆ†å¸ƒã€1ã€‘çš„ç¦»æ•£ä»·æ ¼ã€2ã€‘æ ‡è®°ï¼ˆticksï¼‰æ¥ç•Œå®šã€‚æ¯ä¸ªæ ‡è®°ã€7ã€‘éƒ½æœ‰ä¸€ä¸ªç´¢å¼•ã€3ã€‘ï¼Œå¹¶å¯¹åº”ã€4ã€‘ä¸€ä¸ªç‰¹å®šçš„ä»·æ ¼ï¼š
`p(i) = 1.0001^i`

å…¶ä¸­ `p(i)` æ˜¯æ ‡è®° `i` çš„ä»·æ ¼ã€‚
å– `1.0001` çš„å¹‚å…·æœ‰ä¸€ä¸ªç†æƒ³çš„å±žæ€§ï¼šç›¸é‚»ä¸¤ä¸ªæ ‡è®°ä¹‹é—´çš„å·®å¼‚ä¸º0.01%æˆ–1ä¸ªåŸºç‚¹(basis point)ã€‚ã€5ã€‘

CLMM å­˜å‚¨çš„æ˜¯ `âˆšP`ã€6ã€‘ï¼Œè€Œä¸æ˜¯ `P`ã€‚å› æ­¤ï¼Œå…¬å¼å®žé™…ä¸Šæ˜¯ï¼š

`âˆšp_i = âˆš(1.0001^i) = 1.0001^(i/2)`

æ ‡è®°å¯ä»¥æ˜¯æ­£æ•°æˆ–è´Ÿæ•°çš„æ•´æ•°ã€8ã€‘ï¼Œå½“ç„¶ï¼Œå®ƒä»¬ä¸æ˜¯æ— é™çš„ã€‚ CLMM å­˜å‚¨ `âˆšP` ä¸ºä¸€ä¸ªå›ºå®šç‚¹ Q64.64 æ•°å­—ï¼Œè¿™ä¸ªæ•°å­—ä½¿ç”¨64ä½è¡¨ç¤ºæ•´æ•°éƒ¨åˆ†ï¼Œ64ä½è¡¨ç¤ºå°æ•°éƒ¨åˆ†ã€‚å› æ­¤ï¼Œä»·æ ¼ï¼ˆç­‰äºŽ `âˆšP` çš„å¹³æ–¹ï¼‰å¤„äºŽä»¥ä¸‹èŒƒå›´ã€9ã€‘å†…ï¼š  
`[2^(-64), 2^64]`  
è€Œæ ‡è®°çš„èŒƒå›´ã€10ã€‘åˆ™æ˜¯ï¼š  
`[-443636, 443636]`

ä¸¾ä¾‹ï¼š
As an example, âˆš
ð‘(0)â€”the square root price at tick 0â€”is 1,
âˆš
ð‘(1)
is âˆš
1.0001 â‰ˆ 1.00005, and âˆš
ð‘(âˆ’1) is 1 âˆš
1.0001
â‰ˆ 0.99995.


There is a tick at every price p that is an integer power of 1.0001. 




1.1 å¼•å…¥tick  æ ‡è®°çš„ç›®çš„æ˜¯ï¼Ÿ 
æœ€æ ¸å¿ƒçš„åŽŸå› åœ¨äºŽç¦»æ•£åŒ–ä»·æ ¼ï¼Œä¹Ÿå°±æ˜¯å°†è¿žç»­çš„ä»·æ ¼åŒºé—´åˆ†å‰²æˆå›ºå®šçš„ã€å‡åŒ€çš„é—´éš”ï¼ˆticksï¼‰ã€‚é€šè¿‡è¿™ä¸€è¿‡ç¨‹ï¼Œä»·æ ¼å˜åŠ¨ä¸å†æ˜¯æ— ç©·å°çš„ï¼Œè€Œæ˜¯å…·æœ‰å¯æŽ§åˆ¶çš„ã€æœ‰é™çš„èŒƒå›´ã€‚è¿™ä¸ªç¦»æ•£åŒ–çš„è¿‡ç¨‹å¯ä»¥æžå¤§åœ°ç®€åŒ–è®¡ç®—ï¼Œå‡å°‘è¯¯å·®ï¼Œå¹¶ä¸”åœ¨å®žé™…äº¤æ˜“ä¸­ä¸ºå‚ä¸Žè€…æä¾›æ›´å¯é¢„æµ‹å’Œæ›´ç¨³å®šçš„ä»·æ ¼æ³¢åŠ¨ã€‚

1.2 ticks ç‰¹æ€§ 
å‚è€ƒæ¥æºï¼šhttps://docs.uniswap.org/concepts/protocol/concentrated-liquidity
ç‰¹æ€§1ï¼š åŸºäºŽtickè®¡ç®—ä»·æ ¼æ–¹å¼
Ticks are the boundaries between discrete areas in price space. Ticks are spaced such that an increase or decrease of 1 tick represents a 0.01% increase or decrease in price at any point in price space.

ä¸¾ä¾‹ï¼š
Letâ€™s assume that a particular assetâ€™s price space is represented by ticks, where the price can change in discrete steps. In this example:

Each tick represents a 0.01% change in price.

Step-by-step explanation:
Starting Price:
Suppose the current price of the asset is 100.

Price Increase by 1 Tick:
If the price increases by 1 tick, that represents a 0.01% increase.
A 0.01% increase in price from 100 is calculated as:

100
Ã—
0.0001
=
0.01
100Ã—0.0001=0.01
So, the new price after a 1 tick increase will be:

100
+
0.01
=
100.01
100+0.01=100.01
Price Decrease by 1 Tick:
Similarly, if the price decreases by 1 tick, that represents a 0.01% decrease.
A 0.01% decrease from 100 is:

100
Ã—
0.0001
=
0.01
100Ã—0.0001=0.01
So, the new price after a 1 tick decrease will be:

100
âˆ’
0.01
=
99.99
100âˆ’0.01=99.99
In conclusion:
Each tick moves the price by a fixed 0.01% either up or down.

From a starting price of 100, moving 1 tick up will result in a price of 100.01, while moving 1 tick down will result in a price of 99.99.


1.3 tick åšä¸ºboundaryçš„è§£é‡Š
Imagine you're at a fence that separates two properties, and the fence acts as the boundary between them. You can't cross from one property to the other without going through the fence. In the same way, in the context of price space, each tick serves as a boundary that defines the minimum price movement. If you want the price to go from one level to the next, you must cross a boundary (i.e., move one tick).

Visualizing the Concept:
Consider this example with a starting price of 100:

Boundary 1: Price 100.00 (the first boundary or level).

Boundary 2: Price 100.01 (after the first tick increase, crossing to the next boundary).

Boundary 3: Price 100.02 (after the second tick increase, crossing again).

So, the boundaries are the points where the price moves to the next level, and each time the price crosses a boundary, it increments by a fixed amount (like 0.01%).

In this case:

Boundaries are the discrete price levels such as 100.00, 100.01, 100.02, etc.

The price can only move between these boundaries by crossing them in steps defined by the tick size (0.01% in your example).

1.4 tick å’ŒæµåŠ¨æ€§ä»“ä½å…³ç³»
Ticks function as boundaries for liquidity positions. When a position is created, the provider must choose the lower and upper tick that will represent their position's borders.

1.5 tick åœ¨swapä¸­çš„ä½œç”¨
As the spot price changes during swapping, the pool contract will continuously exchange the outbound asset for the inbound, progressively using all the liquidity available within the current tick interval1 until the next tick is reached. At this point, the contract switches to a new tick and activates any dormant liquidity within a position that has a boundary at the newly active tick.

è§£é‡Šï¼š
1. Spot Price and Ticks:
The spot price changes continuously as assets are swapped. In a CLMM, the liquidity is concentrated within specific tick intervals, and as the price moves, the pool contract will progressively use all the liquidity within the current tick interval until it hits the next tick boundary.

2. Contract Switching Ticks:
Once the spot price reaches the next tick boundary, the contract switches to the next interval and activates any liquidity that has been dormant in that tick interval. This is what allows liquidity providers to focus their capital on smaller price ranges, optimizing their capital efficiency.
ä¸¾ä¾‹ï¼š
1. Example:
Letâ€™s assume we are dealing with a pool that has two assets: Asset A and Asset B. The price of Asset A is 100 when we begin the swap. For simplicity, letâ€™s say we are swapping Asset B for Asset A.

Initial State:

The pool has liquidity concentrated between the price range of 100 and 101. This means that the ticks in this range are active, and the liquidity can be used for swaps.

Letâ€™s say the tick interval is 0.01, meaning that the price can move in increments of 0.01.

Swap Starts:

The spot price starts at 100 and is used for the swap.

As Asset A is swapped into the pool for Asset B, the pool contract will use the liquidity available in the range from 100.00 to 100.01.

Spot Price Reaches Next Tick (100.01):

As the swap continues, the spot price increases to 100.01. At this point, the contract has used up all the liquidity in the 100.00-100.01 range.

Now, the contract will switch to the next tick boundary, which is 100.01, and activate any liquidity that was dormant at this price range.

The liquidity between 100.01 and 100.02 becomes active and can now be used for further swaps.

Liquidity Usage Continues:

The spot price continues to increase as swaps happen, and as it crosses each tick boundary (e.g., 100.02, 100.03), the contract will keep switching to the new ticks, activating dormant liquidity within that range.

The process will continue until the price reaches a point where liquidity is exhausted or until the price changes enough to hit a new price range, triggering the activation of new liquidity.


1.6 æ¯ä¸ªæ± å­çš„ticksæ•°é‡æ˜¯å›ºå®šçš„ ï¼Œä½†æ˜¯åªæœ‰ä¸€éƒ¨åˆ†serve as active ticks. 
active ticksè§£é‡Šï¼š
The active ticks are the ones where liquidity providers have deposited liquidity for price ranges that are currently being used.
When the price reaches the tick boundaries, the liquidity in that tick becomes active and can be used for swaps.

1.7 tick spacing å’Œ swap feeçš„å…³ç³»
swap feeè§£é‡Šï¼š
A swap fee is the fee charged to traders when swapping assets in the pool.

Lower Fee Tiers (e.g., 0.05%):
For lower fee tiers, liquidity providers are incentivized to have liquidity in smaller price ranges. This means the ticks in these pools can be closer together, meaning price changes can happen in smaller increments.

Why Does This Happen?  ã€small price movementsã€‘
Lower Fee Tiers (Closer Ticks):
In lower fee tiers (like 0.05%), thereâ€™s a greater incentive for liquidity providers to position their liquidity closer together. Since the fee is low, the trading volume would need to be higher to make a good return on investment. Therefore, more granular price steps (closer ticks) allow liquidity providers to better capture small price movements and take advantage of more trading opportunities.



Higher Fee Tiers (e.g., 1%):
For higher fee tiers, liquidity providers are incentivized to have liquidity over wider price ranges. This means the ticks are farther apart, and the price increments are larger, which allows for higher potential fees for liquidity providers due to higher trading volume or larger price movements.

Higher Fee Tiers (Wider Ticks):
In higher fee tiers (like 1%), liquidity providers can afford to have liquidity spread over a wider price range, as they earn more fees per trade. The fewer trades (due to higher fees), the wider the tick spacing can be, allowing for more flexibility in where liquidity is placed.


ç¤ºä¾‹ï¼š
Letâ€™s assume we have a Uniswap V3 pool with Asset A and Asset B. The current price is 100 Asset B per 1 Asset A.

Pool with 0.05% Fee Tier:

In a low-fee pool, ticks might be spaced closely together. For example:

Tick 1: Price = 100 (Asset A = 100 Asset B)

Tick 2: Price = 100.01

Tick 3: Price = 100.02

Tick 4: Price = 100.03

The closer tick spacing allows liquidity providers to position liquidity in smaller, more granular price ranges.

In this case, closer ticks allow liquidity providers to capture more small price movements since they can place liquidity closer to the current price.



Pool with 1% Fee Tier:

In a high-fee pool, ticks might be spaced farther apart. For example:

Tick 1: Price = 100 (Asset A = 100 Asset B)

Tick 2: Price = 102

Tick 3: Price = 104

Tick 4: Price = 106

The wider tick spacing means liquidity providers are providing liquidity over a larger price range.

In this case, the wider tick spacing reflects the fact that liquidity providers are expecting less frequent trades due to the higher fee, but they earn higher fees per trade.



1.8. tickå¯¹äº¤æ˜“æˆæœ¬çš„å½±å“
While inactive ticks have no impact on transaction cost during swaps, crossing an active tick does increase the cost of the transaction in which it is crossed, as the tick crossing will activate the liquidity within any new positions using the given tick as a border.

ç¤ºä¾‹ï¼š
Example to Illustrate:
Letâ€™s assume youâ€™re swapping Asset A for Asset B, and the price of Asset A is currently 100 (per Asset B).

Initial Ticks:

Tick 1: Price 100 (Liquidity active here).

Tick 2: Price 101 (Liquidity active here).

Tick 3: Price 102 (Liquidity inactive here).

So, the current active ticks are at 100 and 101, and liquidity is available only at these levels.

Swap Starts:
Letâ€™s say youâ€™re swapping Asset A for Asset B, and the spot price starts at 100.

Tick Crossing:
If the price moves from 100 to 101, tick 2 gets crossed. This means that the contract is now activating the liquidity in the 101 price range. As a result, the transaction cost increases because liquidity is now being used at the new price range (101).

Before crossing tick 2: The pool only had liquidity at tick 1 (100).

After crossing tick 2: The pool now activates liquidity at tick 2 (101), and the price needs to adjust according to the available liquidity.

This means you might end up paying a slightly higher price for Asset B than expected because the price range has shifted and liquidity has moved.


1.9 ç¨³å®šå¸äº¤æ˜“åº”è¯¥é‡‡ç”¨è¾ƒä½Žçš„tick spacking 
In areas where capital efficiency is paramount, such as stable coin pairs, narrower tick spacing increases the granularity of liquidity provisioning and will likely lower price impact when swapping - the result being significantly improved prices for stable coin swaps.


1.10 Tick å’Œ virtual liquidityçš„å…³ç³»ï¼Ÿ 
Ticks represent prices at
which the virtual liquidity of the contract can change

1.11 å½“liquidity è¢«æ·»åŠ åˆ° a range?
å¦‚æžœ one or both of the ticks æ²¡æœ‰ä½œä¸º a bound in an existing position, that  tick is  initialized. 
existing positionå¦‚ä½•ç†è§£ï¼Ÿ 
means that other liquidity providers might have already provided liquidity between those ticks.

initialize tickä»€ä¹ˆæ„æ€?
Initialized here means that the system sets up that tick as an active boundary for liquidity provision. Essentially, the tick starts functioning as a price level that will now hold liquidity.
Initialization makes the tick available for active trading. Without initializing the tick, the price level wouldnâ€™t have liquidity available to be used in trades.

rangeå¦‚ä½•ç†è§£ï¼Ÿ æœ‰ä¸¤ä¸ªtickæž„æˆï¼Œåˆ†åˆ«æž„æˆå·¦ bound å’Œ å³ bound 
As a liquidity provider, you're adding your liquidity to a specific price range (which is defined by two ticks, e.g., from tick 100 to tick 105).


1.12 tickspaceæ˜¯è°è®¾å®šçš„ï¼Ÿ 







æ‹“å±•å­¦ä¹ :
1. https://app.uniswap.org/whitepaper-v3.pdf